#!/bin/bash

# Update system packages
sudo dnf update -y

# Install Git, Apache, PHP, and MariaDB
sudo dnf install -y git httpd php php-mysqli mariadb105

# Start and enable Apache
sudo systemctl enable httpd
sudo systemctl start httpd

# Add ec2-user to the apache group
sudo usermod -a -G apache ec2-user

# Set proper ownership and permissions for the web directory
sudo chown -R ec2-user:apache /var/www
sudo chmod 2775 /var/www
sudo find /var/www -type d -exec chmod 2775 {} \;
sudo find /var/www -type f -exec chmod 0664 {} \;

# Clone your GitHub repository
cd /home/ec2-user
git clone https://github.com/george-848/aws-3_Tier_App.git

# Move the app files to the Apache web root
cd aws-3_Tier_App/section8/resource-files/VeganStudioSourceCode/v5/
sudo mv * /var/www/html/

# Clean up (remove the cloned repo)
cd /home/ec2-user
sudo rm -rf aws-3_Tier_App

# Restart Apache to load the new files
sudo systemctl restart httpd

echo "Deployment completed successfully."
